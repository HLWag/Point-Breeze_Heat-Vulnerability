---
title: "PB Heat Analysis"
author: "Hannah Wagner"
date: "11/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)
library(mapview)
library(tidycensus)
library(remotes)
install_github("yonghah/esri2sf")
library("esri2sf")
library(ggmap)
library(viridis)
install.packages("lwgeom")
library(lwgeom)
```

```{r}
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 13,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "lightskyblue1", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.1,.2,.3,.4,.5,.6,.7,.8, .9), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                          c(.01,.1,.2,.3,.4,.5,.6,.7,.8, .9), na.rm=T)
  }
}
q10 <- function(variable) {as.factor(ntile(variable, 10))}

palette10 <- c("#5e4fa2", "#3288bd", "#66c2a5",   "#abdda4", "#e6f598", "#fee08b", "#fdae61", "#f46d43",   "#d53e4f", "#9e0142")
palette10_2 <- c("#313695", "#4575b4", "#74add1",   "#abd9e9", "#e0f3f8", "#fee090", "#fdae61", "#f46d43",   "#d73027", "#a50026")

q5 <- function(variable) {as.factor(ntile(variable, 5))}

qBr5 <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],2),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                 c(.01,.2,.4,.6,.8), na.rm=T)
  }
}


# Load hexadecimal color palette
palette5 <- c("#fff7ec", "#fdd49e", "#fc8d59", "#d7301f", "#7f0000")
palette5_2 <- c("#ffffcc", "#fed976", "#fd8d3c", "#e31a1c", "#800026")
palette5_3<-c("#ffffd9", "#c7e9b4", "#41b6c4", "#225ea8", "#081d58")
```


Read in Polygon Data
```{r}
url <- "https://services3.arcgis.com/9nfxWATFamVUTTGb/arcgis/rest/services/Heat%20Exposure/FeatureServer/0"
df <- esri2sf(url, geomType = "esriGeometryPolygon", crs=4326)
plot(df)
```

```{r}
ggplot()+
  geom_sf(data=df, aes(fill=q10(AvgTempDiff_F)))+
  scale_fill_manual(values = palette10_2,
                    labels=qBr(df,"AvgTempDiff_F"),
                     name="Decile\nBreaks") +
  mapTheme()
```

```{r}
ggplot()+
  geom_sf(data=df, aes(fill=q10(AvgTemp_F)))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.1)+
  scale_fill_manual(values = palette10_2,
                    labels=qBr(df,"AvgTemp_F"),
                     name="Decile\nBreaks") +
  labs(title = "Surface Temperatures: ", 
       subtitle = "Chicago, IL",
       caption="Figure 3: Median Rent by census tract for 2009 and 2017. The red outline indicates TOD census tracts.") +
  mapTheme()

```

PPR Properties
```{r}
PPR_properties<- st_read("http://data-phl.opendata.arcgis.com/datasets/d52445160ab14380a673e5849203eb64_0.geojson")
PPR_buildings<- st_read("http://data-phl.opendata.arcgis.com/datasets/97e90a049a35453ba0c51f974b3c77b4_0.geojson")
PPR_spraygrounds<- st_read("http://data-phl.opendata.arcgis.com/datasets/a148cc904d374b22bd456e44a044d554_0.geojson")
PPR_swimming<- st_read("http://data-phl.opendata.arcgis.com/datasets/c6f6176968f04d3f88adbc4c362af55d_0.geojson")
schools<- st_read("http://data.phl.opendata.arcgis.com/datasets/d46a7e59e2c246c891fbee778759717e_0.geojson")
```


FINAl
```{r}
ggplot()+
  geom_sf(data=df, aes(fill=q5(AvgTemp_F)))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.5)+
  geom_sf(data=PPR_spraygrounds, color="black", size=2)+
  scale_fill_manual(values = palette5_2,
                    labels=qBr5(df,"AvgTemp_F"),
                     name="Quantile\nBreaks") +
  labs(title = "Average Surface Temperatures on the 7 Hottest Days From 2013-2015",
       caption="Average surface temperature on the 7 hottest days from 2013 to 2015. Point Breeze is outlined in black; points indicate Sprayground locations.")+
  mapTheme()

```


```{r}
ggplot()+
  geom_sf(data=df, aes(fill=q5(AvgTempDiff_F)))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.1)+
  scale_fill_manual(values = palette5_2,
                    labels=qBr5(df,"AvgTempDiff_F"),
                     name="Quantile\nBreaks") +
  labs(title = "Surface Temperatures: ", 
       subtitle = "Chicago, IL",
       caption="Figure 3: Median Rent by census tract for 2009 and 2017. The red outline indicates TOD census tracts.") +
  mapTheme()

```

Make temp data only for PB
```{r}
df_PB<-
  df%>%
  filter(GEOID10 == 421010020001 |
           GEOID10 ==  421010020002 |
           GEOID10 == 421010021001 |
           GEOID10 == 421010021002 |
           GEOID10 == 421010022001 |
           GEOID10 == 421010022002 |
           GEOID10 == 421010022003 |
           GEOID10 == 421010031001 |
           GEOID10 == 421010031002 |
           GEOID10 == 421010031003 |
           GEOID10 == 421010031004 |
           GEOID10 == 421010031005 |
           GEOID10 == 421010031006 |
           GEOID10 == 421010032001 |
           GEOID10 == 421010032002 |
           GEOID10 == 421010032003 |
           GEOID10 == 421010032004 |
           GEOID10 == 421010032005 |
           GEOID10 == 421010032006 |
           GEOID10 == 421010030011 |
           GEOID10 == 421010030012 |
           GEOID10 == 421010030013 |
           GEOID10 == 421010030014 |
           GEOID10 == 421010030015 |
           GEOID10 == 421010030021 |
           GEOID10 == 421010030022 |
           GEOID10 == 421010030023 |
           GEOID10 == 421010030024 )

mean(df_PB$AvgTemp_F)
mean(df$AvgTemp_F)


ggplot()+
  geom_sf(data=df_PB, aes(fill=q5(AvgTemp_F)))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.5)+
  scale_fill_manual(values = palette5_2,
                    labels=qBr5(df_PB,"AvgTemp_F"),
                     name="Quantile\nBreaks") +
  labs(title = "Average Surface Temperatures on the 7 Hottest Days From 2013-2015 ")+
  mapTheme

palette5_2 <- c("#ffffcc", "#fed976", "#fd8d3c", "#e31a1c", "#800026")

cols<- c("74.8725"="#ffffcc", "83.06"="#fed976", "85.08" = "#fd8d3c", "86.8" = "#e31a1c", "88.17" = "#800026")

ggplot()+
  geom_sf(data=df_PB, aes(fill=cut(AvgTemp_F, breaks=c(0,74.8725, 83.06, 85.08, 86.8, 88.17, 96))))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.5)+
  scale_fill_manual(values = cols) +
  labs(title = "Average Surface Temperatures on the 7 Hottest Days From 2013-2015 ")+
  mapTheme()


ggplot()+
  geom_sf(data=df_PB, aes(fill=AvgTemp_F))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.5)+
  scale_fill_manual(values = palette5_2, breaks= c("74.8725", "83.06", "85.08", "86.8", "88.17")) +
  labs(title = "Average Surface Temperatures on the 7 Hottest Days From 2013-2015 ")+
  mapTheme()

```
notes:https://phl.maps.arcgis.com/home/item.html?id=77827f2e8d5b4a23a2377fff74dac355&sublayer=0

from: https://phl.maps.arcgis.com/apps/webappviewer/index.html?id=9ef74cdc0c83455c9df031c868083efd
Heat Sensitivity data

Demographic & Socioeconomic:
·Age (percent of population over 65 years old)
·Educational attainment (percent of population over 25 years old without a high school diploma)
·Language barrier (percent of limited English-speaking households)
·Low socioeconomic status (percent of population below the Federal Poverty Level)
·Race & ethnicity (percent of population identifying as non-white)
·Social isolation (percent of population over 65 years old and living alone)



https://nccd.cdc.gov/BRFSSPrevalence/rdPage.aspx?rdReport=DPH_BRFSS.ExploreByLocation&rdProcessAction=&SaveFileGenerated=1&irbLocationType=States&islLocation=42&islState=&islCounty=&islClass=CLASS01&islTopic=TOPIC03&islYear=2019&hidLocationType=States&hidLocation=42&hidClass=CLASS01&hidTopic=TOPIC03&hidTopicName=Alcohol+Consumption&hidYear=2019&irbShowFootnotes=Show&rdICL-iclIndicators=DRNKANY5&iclIndicators_rdExpandedCollapsedHistory=&iclIndicators=DRNKANY5&hidPreviouslySelectedIndicators=&DashboardColumnCount=2&rdShowElementHistory=&rdScrollX=0&rdScrollY=94.4000015258789&rdRnd=91164

SVI Data
```{r}
SVI_2018<-st_read("C:/Users/wagne/OneDrive - PennO365/Academic/Fall 2020/CPLN 501 Quantitative Planning Analysis/Assignments/Final/Data/SVI 2018/Pennsylvania/SVI2018_PENNSYLVANIA_tract.shp")%>%
  filter(COUNTY=="Philadelphia")%>%
 # select(starts_with(c("EP", "RPL", "LOCATION")))%>%
  mutate(year="2018")

SVI_2010<-read.csv("C:/Users/wagne/OneDrive - PennO365/Academic/Fall 2020/CPLN 501 Quantitative Planning Analysis/Assignments/Final/Data/SVI 2010/Pennsylvania.csv")%>%
  filter(COUNTY=="Philadelphia County")%>%
 # select(starts_with(c("E_P", "P", "R_P", "LOCATION")))%>%
  mutate(year="2010")

```

```{r}
SVI_2018_plot <- SVI_2018%>%
  select(FIPS, RPL_THEMES)%>%
  rename("SVI_2018"="RPL_THEMES")

SVI_2010_plot <- SVI_2010%>%
  select(FIPS, R_PL_THEMES)%>%
  rename("SVI_2010"="R_PL_THEMES")

SVI_2010_plot$FIPS<-as.character(SVI_2010_plot$FIPS)

SVI_plot<-
  left_join(SVI_2018_plot, SVI_2010_plot, by="FIPS")%>%
  mutate(SVI_2010_p = ifelse(SVI_2010 < 0, NA, SVI_2010))%>%
  mutate(SVI_2018_p = ifelse(SVI_2018 < 0, NA, SVI_2018))

  
SVI_2010_clean <-
  SVI_plot %>%
  select(FIPS, SVI_2010_p)%>%
  rename("SVI"="SVI_2010_p")%>%
  mutate(year="2010")

SVI_2018_clean<-
  SVI_plot%>%
  select(FIPS, SVI_2018_p)%>%
  rename("SVI"="SVI_2018_p")%>%
  mutate(year="2018")

SVI_ALL<- rbind(SVI_2010_clean,SVI_2018_clean)
```


FINAL PLOTS
```{r}
ggplot()+
  geom_sf(data=SVI_ALL, aes(fill=SVI))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.5)+
    scale_fill_viridis(discrete = TRUE)+
  facet_wrap(~year)+
  mapTheme()
```  

PB Specific Plot
```{r}
SVI_ALL_PB<-
  SVI_ALL%>%
  filter(FIPS == 42101002000 |
           FIPS == 42101002100 |
           FIPS == 42101002200 |
           FIPS == 42101003100 |
           FIPS == 42101003200 |
           FIPS == 42101003001 |
           FIPS == 42101003002 )%>%
  mutate(Census=substr(FIPS,nchar(FIPS)-4+1, nchar(FIPS)))%>%
  mutate(Census_edit=c("Census Tract 20", "Census Tract 21", "Census Tract 22", "Census Tract 30.01", "Census Tract 30.02", "Census Tract 31", "Census Tract 32", "Census Tract 20", "Census Tract 21", "Census Tract 22", "Census Tract 30.01", "Census Tract 30.02", "Census Tract 31", "Census Tract 32"))%>%
  mutate(SVI_round=round(SVI, 2))

 

ggplot()+
  geom_sf(data=SVI_ALL_PB, aes(fill=SVI))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.5)+
  scale_fill_steps2(n.breaks = 3, low="#ffffcc", mid="#41b6c4", high="#253494", midpoint=.5)+
  geom_sf_label(data=SVI_ALL_PB, aes(label=Census_edit), size=12)+
  facet_wrap(~year)+
  labs(title="Social Vulnerability Index")+
  #theme(legend.position="bottom")+
  theme(strip.text = element_text(size=30),
        plot.title = element_text(size = 20,colour = "black"),
        legend.text=element_text(size=12),
        legend.position = "bottom")+
  mapTheme()

ggplot()+
  geom_sf(data=SVI_ALL_PB, aes(fill=SVI))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.5)+
  scale_fill_steps2(n.breaks = 3, low="#ffffcc", mid="#41b6c4", high="#253494", midpoint=.5)+
  geom_sf_label(data=SVI_ALL_PB, aes(label=SVI_round), size=7)+
  geom_sf_label(data=SVI_ALL_PB, aes(label=Census_edit), size=7, nudge_y=.0008)+
  facet_wrap(~year)+
  labs(title="Social Vulnerability Index")+
  #theme(legend.position="bottom")+
  theme(strip.text = element_text(size=30),
        plot.title = element_text(size = 20,colour = "black"),
        legend.text=element_text(size=12),
        legend.position = "bottom")+
  mapTheme()
```

```{r}
ggplot()+
  geom_sf(data=SVI_ALL, aes(fill=SVI))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.5)+
  scale_fill_steps2(n.breaks = 5, low="#ffffcc", mid="#41b6c4", high="#253494", midpoint=.5)+
  facet_wrap(~year)+
  labs(title="Social Vulnerability Index")+
  #theme(legend.position="bottom")+
  theme(strip.text = element_text(size=18),
        plot.title = element_text(size = 20,colour = "black"))+
  mapTheme()
```  

```{r}
ggplot()+
  geom_sf(data=SVI_ALL_PB)+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.5)+
  geom_sf_label(data=SVI_ALL_PB, aes(label=Census_edit), size=8)+
  mapTheme()

mapview(SVI_ALL_PB)
```


```{r}
st_area(PB_boundary)

```




```{r}
cols<-c(".001"="#ffffd9", ".2"="#c7e9b4", ".4" = "#41b6c4", ".6" = "#225ea8", ".8" = "#081d58")
```

```{r}
ggplot()+
  geom_sf(data=SVI_plot, aes(fill=SVI_2010_p))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.5)+
    scale_fill_manual(values=cols, 
                      breaks=c("0.001", ))
  mapTheme()
  
```




```{r}
ggplot()+
  geom_sf(data=SVI_plot, aes(fill=q5(SVI_2010_p)))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.5)+
    scale_fill_manual(values = palette5_2,
                    labels=qBr5(SVI_plot,"SVI_2010_p"),
                     name="Quantile\nBreaks") +
  mapTheme()
  
```

```{r}
ggplot()+
  geom_sf(data=SVI_plot, aes(fill=q5(SVI_2018_p)))+
  geom_sf(data = PB_boundary, fill = "transparent", color = "black", size =1.5)+
    scale_fill_manual(values = palette5_2,
                    labels=qBr5(SVI_plot,"SVI_2018_p"),
                     name="Quantile\nBreaks") +
  mapTheme()
  
```


```{r}
#PB Map
variable_pop<-c(total_pop="B01003_001")

PB <- get_acs(geography = "tract",
                          state = 42,
                          county= 101,
                          geometry=T,
                          variables = variable_pop,
                          year = 2018,
                          survey = "acs5")%>%
  filter(GEOID == 42101002000 |
           GEOID == 42101002100 |
           GEOID == 42101002200 |
           GEOID == 42101003100 |
           GEOID == 42101003200 |
           GEOID == 42101003001 |
           GEOID == 42101003002 )

Philly<-get_acs(geography = "tract",
                          state = 42,
                          county= 101,
                          geometry=T,
                          variables = variable_pop,
                          year = 2018,
                          survey = "acs5")

Philly_boundary<-st_read("http://data.phl.opendata.arcgis.com/datasets/405ec3da942d4e20869d4e1449a2be48_0.geojson")
  
ggplot()+
  geom_sf(data=Philly)+
  geom_sf(data=PB, fill="dodgerblue2")+
  labs(title="Point Breeze Neighborhood of Philadelphia",
       caption="Point Breeze Neighborhood: Census Tracts 20, 21, 22, 32, 31, 30.02, and 30.01")+
  mapTheme()

PB_boundary<-
  PB%>%
  st_union()

ggplot()+
  geom_sf(data=PB_boundary)
``` 


```{r}
SVI_2018_PB<-SVI_2018%>%
  filter(LOCATION == "Census Tract 20, Philadelphia County, Pennsylvania" |
           LOCATION == "Census Tract 21, Philadelphia County, Pennsylvania" |
           LOCATION == "Census Tract 22, Philadelphia County, Pennsylvania" |
           LOCATION == "Census Tract 31, Philadelphia County, Pennsylvania" |
           LOCATION == "Census Tract 32, Philadelphia County, Pennsylvania" |
           LOCATION == "Census Tract 30.01, Philadelphia County, Pennsylvania" |
           LOCATION == "Census Tract 30.02, Philadelphia County, Pennsylvania")

SVI_2010_PB<-SVI_2010%>%
  filter(LOCATION == "Census Tract 20, Philadelphia County, Pennsylvania" |
           LOCATION == "Census Tract 21, Philadelphia County, Pennsylvania" |
           LOCATION == "Census Tract 22, Philadelphia County, Pennsylvania" |
           LOCATION == "Census Tract 31, Philadelphia County, Pennsylvania" |
           LOCATION == "Census Tract 32, Philadelphia County, Pennsylvania" |
           LOCATION == "Census Tract 30.01, Philadelphia County, Pennsylvania" |
           LOCATION == "Census Tract 30.02, Philadelphia County, Pennsylvania")

```
